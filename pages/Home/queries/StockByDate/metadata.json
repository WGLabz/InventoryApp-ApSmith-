{
  "gitSyncId": "6703b251c982f54ff180d40c_39d5183f-f7e8-44c2-a2b1-3208802705a1",
  "id": "Home_StockByDate",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH date_series AS (\n  -- Generate a series of dates between the selected start and end date\n  SELECT generate_series(\n    TO_DATE('{{ StartDate.selectedDate }}', 'YYYY-MM-DD'), \n    TO_DATE('{{ EndDate.selectedDate }}', 'YYYY-MM-DD'), \n    '1 day'::interval\n  )::date AS date\n),\nordered AS (\n  -- Total ordered per day within the selected date range\n  SELECT \n    order_date::date AS date,\n    SUM(quantity_ordered) AS total_bought\n  FROM order_parts\n  WHERE order_date::date BETWEEN TO_DATE('{{ StartDate.selectedDate }}', 'YYYY-MM-DD') \n                             AND TO_DATE('{{ EndDate.selectedDate }}', 'YYYY-MM-DD')\n  GROUP BY order_date::date\n),\nused AS (\n  -- Total used per day within the selected date range\n  SELECT \n    date::date AS date,  -- Replaced use_date with date\n    SUM(quantity_used) AS total_used\n  FROM project_components\n  WHERE date::date BETWEEN TO_DATE('{{ StartDate.selectedDate }}', 'YYYY-MM-DD') \n                       AND TO_DATE('{{ EndDate.selectedDate }}', 'YYYY-MM-DD')\n  GROUP BY date::date\n),\ndaily_stock AS (\n  -- Combine bought and used data for each day\n  SELECT\n    COALESCE(o.date, u.date) AS date,\n    COALESCE(o.total_bought, 0) AS total_bought,\n    COALESCE(u.total_used, 0) AS total_used,\n    (COALESCE(o.total_bought, 0) - COALESCE(u.total_used, 0)) AS stock_change\n  FROM ordered o\n  FULL OUTER JOIN used u ON o.date = u.date\n),\ncombined_data AS (\n  -- Join the date series with the stock data\n  SELECT\n    d.date,\n    COALESCE(ds.stock_change, 0) AS stock_change\n  FROM date_series d\n  LEFT JOIN daily_stock ds ON d.date = ds.date\n)\n-- Final result: cumulative stock per day with carryover for missing dates\nSELECT\n  date AS x,\n  SUM(stock_change) OVER (ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS y\nFROM combined_data\nORDER BY date;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "Koyeb Postgres DB",
      "isAutoGenerated": false,
      "name": "Koyeb Postgres DB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "StockByDate",
    "pageId": "Home",
    "runBehaviour": "ON_PAGE_LOAD",
    "userSetOnLoad": false
  }
}